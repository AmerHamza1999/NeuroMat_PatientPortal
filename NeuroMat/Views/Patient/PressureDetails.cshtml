@model NeuroMat.Models.Patient

@{
    ViewData["Title"] = "Pressure Analysis";
    var latestFrame = Model.PressureFrames
        .OrderByDescending(f => f.Timestamp)
        .First();
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container mt-4">

   
    <h2 class="mb-3">@Model.DisplayName</h2>

    
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">Peak Pressure Index</h6>
                    <h3 class="fw-bold">@latestFrame.PeakPressureIndex</h3>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">Contact Area %</h6>
                    <h3 class="fw-bold">@latestFrame.ContactAreaPercent %</h3>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">Last Updated</h6>
                    <h5>@latestFrame.Timestamp.ToLocalTime()</h5>
                </div>
            </div>
        </div>
    </div>

    
    <div class="row">
        <div class="col-md-6">
            <canvas id="peakChart"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="contactChart"></canvas>
        </div>
    </div>

    <div class="mt-5 mb-5 pb-5 d-flex gap-3 flex-wrap">

    <form asp-controller="Patient"
          asp-action="ResetPressure"
          method="post"
          class="d-inline">

        @Html.AntiForgeryToken()
        <input type="hidden" name="patientId" value="@Model.Id" />

        <button type="submit" class="btn btn-primary">
            Upload New CSV
        </button>
    </form>

    <a asp-controller="Home"
       asp-action="Index"
       class="btn btn-secondary">
        Back to Dashboard
    </a>

            <button type="button" class="btn btn-primary">
            Comment
        </button>

                <button type="button" class="btn btn-primary">
            Setting
        </button>

</div>

</div>

<script>
    const frames = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Model.PressureFrames
            .OrderBy(f => f.Timestamp)
            .Select(f => new {
                time = f.Timestamp.ToString("HH:mm:ss"),
                peak = f.PeakPressureIndex,
                contact = f.ContactAreaPercent
            })
    ));

    const labels = frames.map(f => f.time);

    
    new Chart(document.getElementById('peakChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Peak Pressure Index',
                data: frames.map(f => f.peak),
                borderColor: '#0d6efd',
                fill: false,
                tension: 0.3
            }]
        }
    });

    
    new Chart(document.getElementById('contactChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Contact Area %',
                data: frames.map(f => f.contact),
                borderColor: '#198754',
                fill: false,
                tension: 0.3
            }]
        }
    });
</script>
